drop table if EXISTS trews_backup;
create table trews_backup as
  select * from trews;


DELETE FROM trews;
INSERT INTO trews
        (dataset_id, model_id, enc_id, tsp, pao2,shock_idx,hemoglobin,spo2,worst_sofa,nbp_dias,urine_output_24hr,amylase,creatinine,mapm,temperature,sodium,fluids_intake_24hr,gcs,rass,urine_output_6hr,paco2,resp_rate,neurologic_sofa,hematologic_sofa,renal_sofa,bun,resp_sofa,lipase,cardio_sofa,heart_rate,wbc,minutes_since_any_organ_fail,sirs_wbc_oor,sirs_raw,sirs_hr_oor,sirs_temperature_oor,sirs_resp_oor,hypotension_intp,gender,age,chronic_pulmonary_hist,heart_failure_hist,chronic_bronchitis_diag,esrd_prob,heart_arrhythmias_diag,heart_failure_diag,heart_arrhythmias_prob,esrd_diag,emphysema_hist,trewscore)
        (select cdm_twf.dataset_id, 1, cdm_twf.enc_id, tsp, (coalesce(((pao2::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'pao2')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'pao2')) * -0.017058, 0) - -0.0378364444444)/3.40346 pao2,(coalesce(((shock_idx::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'shock_idx')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'shock_idx')) * 0.149391, 0) - -0.0378364444444)/3.40346 shock_idx,(coalesce(((hemoglobin::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'hemoglobin')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'hemoglobin')) * -0.057413, 0) - -0.0378364444444)/3.40346 hemoglobin,(coalesce(((spo2::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'spo2')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'spo2')) * -0.044062, 0) - -0.0378364444444)/3.40346 spo2,(coalesce(((worst_sofa::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'worst_sofa')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'worst_sofa')) * -0.192198, 0) - -0.0378364444444)/3.40346 worst_sofa,(coalesce(((nbp_dias::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'nbp_dias')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'nbp_dias')) * -0.014728, 0) - -0.0378364444444)/3.40346 nbp_dias,(coalesce(((urine_output_24hr::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'urine_output_24hr')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'urine_output_24hr')) * -0.152478, 0) - -0.0378364444444)/3.40346 urine_output_24hr,(coalesce(((amylase::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'amylase')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'amylase')) * -0.014844, 0) - -0.0378364444444)/3.40346 amylase,(coalesce(((creatinine::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'creatinine')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'creatinine')) * 0.0064, 0) - -0.0378364444444)/3.40346 creatinine,(coalesce(((mapm::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'mapm')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'mapm')) * -0.001852, 0) - -0.0378364444444)/3.40346 mapm,(coalesce(((temperature::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'temperature')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'temperature')) * 0.058064, 0) - -0.0378364444444)/3.40346 temperature,(coalesce(((sodium::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'sodium')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'sodium')) * -0.065674, 0) - -0.0378364444444)/3.40346 sodium,(coalesce(((fluids_intake_24hr::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'fluids_intake_24hr')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'fluids_intake_24hr')) * 0.041767, 0) - -0.0378364444444)/3.40346 fluids_intake_24hr,(coalesce(((gcs::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'gcs')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'gcs')) * -0.066719, 0) - -0.0378364444444)/3.40346 gcs,(coalesce(((rass::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'rass')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'rass')) * 0.0205, 0) - -0.0378364444444)/3.40346 rass,(coalesce(((urine_output_6hr::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'urine_output_6hr')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'urine_output_6hr')) * -0.023936, 0) - -0.0378364444444)/3.40346 urine_output_6hr,(coalesce(((paco2::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'paco2')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'paco2')) * 0.027342, 0) - -0.0378364444444)/3.40346 paco2,(coalesce(((resp_rate::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'resp_rate')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'resp_rate')) * 0.011693, 0) - -0.0378364444444)/3.40346 resp_rate,(coalesce(((neurologic_sofa::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'neurologic_sofa')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'neurologic_sofa')) * 0.123864, 0) - -0.0378364444444)/3.40346 neurologic_sofa,(coalesce(((hematologic_sofa::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'hematologic_sofa')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'hematologic_sofa')) * 0.018169, 0) - -0.0378364444444)/3.40346 hematologic_sofa,(coalesce(((renal_sofa::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'renal_sofa')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'renal_sofa')) * -0.013432, 0) - -0.0378364444444)/3.40346 renal_sofa,(coalesce(((bun::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'bun')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'bun')) * 0.009256, 0) - -0.0378364444444)/3.40346 bun,(coalesce(((resp_sofa::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'resp_sofa')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'resp_sofa')) * -0.026295, 0) - -0.0378364444444)/3.40346 resp_sofa,(coalesce(((lipase::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'lipase')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'lipase')) * -0.002457, 0) - -0.0378364444444)/3.40346 lipase,(coalesce(((cardio_sofa::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'cardio_sofa')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'cardio_sofa')) * 0.043223, 0) - -0.0378364444444)/3.40346 cardio_sofa,(coalesce(((heart_rate::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'heart_rate')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'heart_rate')) * 0.115013, 0) - -0.0378364444444)/3.40346 heart_rate,(coalesce(((wbc::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'wbc')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'wbc')) * 0.17032, 0) - -0.0378364444444)/3.40346 wbc,(coalesce(((minutes_since_any_organ_fail::numeric - (select coalesce(max(mean), 0) from trews_scaler where fid = E'minutes_since_any_organ_fail')) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'minutes_since_any_organ_fail')) * -0.554753, 0) - -0.0378364444444)/3.40346 minutes_since_any_organ_fail,(coalesce(((sirs_wbc_oor::int - (select coalesce(max(mean), 0) from trews_scaler where fid = E'sirs_wbc_oor') ) / ( select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'sirs_wbc_oor')) * 0.115913, 0) - -0.0378364444444)/3.40346 sirs_wbc_oor,(coalesce(((sirs_raw::int - (select coalesce(max(mean), 0) from trews_scaler where fid = E'sirs_raw') ) / ( select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'sirs_raw')) * -0.023597, 0) - -0.0378364444444)/3.40346 sirs_raw,(coalesce(((sirs_hr_oor::int - (select coalesce(max(mean), 0) from trews_scaler where fid = E'sirs_hr_oor') ) / ( select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'sirs_hr_oor')) * 0.00442, 0) - -0.0378364444444)/3.40346 sirs_hr_oor,(coalesce(((sirs_temperature_oor::int - (select coalesce(max(mean), 0) from trews_scaler where fid = E'sirs_temperature_oor') ) / ( select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'sirs_temperature_oor')) * 0.056907, 0) - -0.0378364444444)/3.40346 sirs_temperature_oor,(coalesce(((sirs_resp_oor::int - (select coalesce(max(mean), 0) from trews_scaler where fid = E'sirs_resp_oor') ) / ( select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'sirs_resp_oor')) * 0.050062, 0) - -0.0378364444444)/3.40346 sirs_resp_oor,(coalesce(((hypotension_intp::int - (select coalesce(max(mean), 0) from trews_scaler where fid = E'hypotension_intp') ) / ( select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'hypotension_intp')) * 0.008333, 0) - -0.0378364444444)/3.40346 hypotension_intp,(coalesce((( coalesce(gender.value::numeric,0) - (select coalesce(max(mean), 0) from trews_scaler where fid = E'gender') ) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'gender')) * -0.008566, 0) - -0.0378364444444)/3.40346 gender,(coalesce((( coalesce(age.value::numeric,0) - (select coalesce(max(mean), 0) from trews_scaler where fid = E'age') ) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'age')) * 0.098005, 0) - -0.0378364444444)/3.40346 age,(coalesce(((  coalesce(chronic_pulmonary_hist.value::bool::int,0) - (select coalesce(max(mean), 0) from trews_scaler where fid = E'chronic_pulmonary_hist') ) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'chronic_pulmonary_hist')) * 0.165895, 0) - -0.0378364444444)/3.40346 chronic_pulmonary_hist,(coalesce(((  coalesce(heart_failure_hist.value::bool::int,0) - (select coalesce(max(mean), 0) from trews_scaler where fid = E'heart_failure_hist') ) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'heart_failure_hist')) * 0.022929, 0) - -0.0378364444444)/3.40346 heart_failure_hist,(coalesce(((  coalesce(chronic_bronchitis_diag.value::bool::int,0) - (select coalesce(max(mean), 0) from trews_scaler where fid = E'chronic_bronchitis_diag') ) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'chronic_bronchitis_diag')) * 0.011004, 0) - -0.0378364444444)/3.40346 chronic_bronchitis_diag,(coalesce(((  coalesce(esrd_prob.value::bool::int,0) - (select coalesce(max(mean), 0) from trews_scaler where fid = E'esrd_prob') ) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'esrd_prob')) * -0.008461, 0) - -0.0378364444444)/3.40346 esrd_prob,(coalesce(((  coalesce(heart_arrhythmias_diag.value::bool::int,0) - (select coalesce(max(mean), 0) from trews_scaler where fid = E'heart_arrhythmias_diag') ) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'heart_arrhythmias_diag')) * -0.018609, 0) - -0.0378364444444)/3.40346 heart_arrhythmias_diag,(coalesce(((  coalesce(heart_failure_diag.value::bool::int,0) - (select coalesce(max(mean), 0) from trews_scaler where fid = E'heart_failure_diag') ) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'heart_failure_diag')) * 0.015856, 0) - -0.0378364444444)/3.40346 heart_failure_diag,(coalesce(((  coalesce(heart_arrhythmias_prob.value::bool::int,0) - (select coalesce(max(mean), 0) from trews_scaler where fid = E'heart_arrhythmias_prob') ) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'heart_arrhythmias_prob')) * -0.024353, 0) - -0.0378364444444)/3.40346 heart_arrhythmias_prob,(coalesce(((  coalesce(esrd_diag.value::bool::int,0) - (select coalesce(max(mean), 0) from trews_scaler where fid = E'esrd_diag') ) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'esrd_diag')) * 0.042275, 0) - -0.0378364444444)/3.40346 esrd_diag,(coalesce(((  coalesce(emphysema_hist.value::bool::int,0) - (select coalesce(max(mean), 0) from trews_scaler where fid = E'emphysema_hist') ) / (select coalesce(max(case when scale = 0 then 1 else scale end), 1) from trews_scaler where fid = E'emphysema_hist')) * 0.00613, 0) - -0.0378364444444)/3.40346 emphysema_hist, null::numeric trewscore
        from cdm_twf
         left outer join cdm_s chronic_pulmonary_hist
                      ON cdm_twf.enc_id = chronic_pulmonary_hist.enc_id
                      AND chronic_pulmonary_hist.fid = 'chronic_pulmonary_hist'
                      AND cdm_twf.dataset_id = chronic_pulmonary_hist.dataset_id
                    left outer join cdm_s heart_failure_hist
                      ON cdm_twf.enc_id = heart_failure_hist.enc_id
                      AND heart_failure_hist.fid = 'heart_failure_hist'
                      AND cdm_twf.dataset_id = heart_failure_hist.dataset_id
                    left outer join cdm_s chronic_bronchitis_diag
                      ON cdm_twf.enc_id = chronic_bronchitis_diag.enc_id
                      AND chronic_bronchitis_diag.fid = 'chronic_bronchitis_diag'
                      AND cdm_twf.dataset_id = chronic_bronchitis_diag.dataset_id
                    left outer join cdm_s esrd_prob
                      ON cdm_twf.enc_id = esrd_prob.enc_id
                      AND esrd_prob.fid = 'esrd_prob'
                      AND cdm_twf.dataset_id = esrd_prob.dataset_id
                    left outer join cdm_s heart_arrhythmias_diag
                      ON cdm_twf.enc_id = heart_arrhythmias_diag.enc_id
                      AND heart_arrhythmias_diag.fid = 'heart_arrhythmias_diag'
                      AND cdm_twf.dataset_id = heart_arrhythmias_diag.dataset_id
                    left outer join cdm_s heart_failure_diag
                      ON cdm_twf.enc_id = heart_failure_diag.enc_id
                      AND heart_failure_diag.fid = 'heart_failure_diag'
                      AND cdm_twf.dataset_id = heart_failure_diag.dataset_id
                    left outer join cdm_s heart_arrhythmias_prob
                      ON cdm_twf.enc_id = heart_arrhythmias_prob.enc_id
                      AND heart_arrhythmias_prob.fid = 'heart_arrhythmias_prob'
                      AND cdm_twf.dataset_id = heart_arrhythmias_prob.dataset_id
                    left outer join cdm_s gender
                      ON cdm_twf.enc_id = gender.enc_id
                      AND gender.fid = 'gender'
                      AND cdm_twf.dataset_id = gender.dataset_id
                    left outer join cdm_s age
                      ON cdm_twf.enc_id = age.enc_id
                      AND age.fid = 'age'
                      AND cdm_twf.dataset_id = age.dataset_id
                    left outer join cdm_s esrd_diag
                      ON cdm_twf.enc_id = esrd_diag.enc_id
                      AND esrd_diag.fid = 'esrd_diag'
                      AND cdm_twf.dataset_id = esrd_diag.dataset_id
                    left outer join cdm_s emphysema_hist
                      ON cdm_twf.enc_id = emphysema_hist.enc_id
                      AND emphysema_hist.fid = 'emphysema_hist'
                      AND cdm_twf.dataset_id = emphysema_hist.dataset_id

        );
        update trews set trewscore = coalesce(pao2,0)+coalesce(shock_idx,0)+coalesce(hemoglobin,0)+coalesce(spo2,0)+coalesce(worst_sofa,0)+coalesce(nbp_dias,0)+coalesce(urine_output_24hr,0)+coalesce(amylase,0)+coalesce(creatinine,0)+coalesce(mapm,0)+coalesce(temperature,0)+coalesce(sodium,0)+coalesce(fluids_intake_24hr,0)+coalesce(gcs,0)+coalesce(rass,0)+coalesce(urine_output_6hr,0)+coalesce(paco2,0)+coalesce(resp_rate,0)+coalesce(neurologic_sofa,0)+coalesce(hematologic_sofa,0)+coalesce(renal_sofa,0)+coalesce(bun,0)+coalesce(resp_sofa,0)+coalesce(lipase,0)+coalesce(cardio_sofa,0)+coalesce(heart_rate,0)+coalesce(wbc,0)+coalesce(minutes_since_any_organ_fail,0)+coalesce(sirs_wbc_oor,0)+coalesce(sirs_raw,0)+coalesce(sirs_hr_oor,0)+coalesce(sirs_temperature_oor,0)+coalesce(sirs_resp_oor,0)+coalesce(hypotension_intp,0)+coalesce(gender,0)+coalesce(age,0)+coalesce(chronic_pulmonary_hist,0)+coalesce(heart_failure_hist,0)+coalesce(chronic_bronchitis_diag,0)+coalesce(esrd_prob,0)+coalesce(heart_arrhythmias_diag,0)+coalesce(heart_failure_diag,0)+coalesce(heart_arrhythmias_prob,0)+coalesce(esrd_diag,0)+coalesce(emphysema_hist,0);